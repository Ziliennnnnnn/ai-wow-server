#!/bin/bash
set -e

# ======================
# æ ¸å¿ƒä¿®æ­£1ï¼šä½¿ç”¨ç»Ÿä¸€è·¯å¾„ + éªŒè¯ç›®å½•
# ======================
WORK_DIR="/root/wow"
echo "[âœ…] å¼ºåˆ¶ä½¿ç”¨ç»Ÿä¸€å·¥ä½œç›®å½•: $WORK_DIR"
mkdir -p "$WORK_DIR"
cd "$WORK_DIR" || exit 1

# ====================== ç³»ç»Ÿæ›´æ–°ä¸ä¾èµ–å®‰è£… ======================
echo "[1/10] æ­£åœ¨æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…ä¾èµ–..."
sudo apt update && sudo apt upgrade -y
sudo apt install -y git cmake make gcc g++ clang libmysqlclient-dev libssl-dev libbz2-dev \
libreadline-dev libncurses-dev mysql-server libboost-all-dev curl unzip sudo screen

# ====================== é˜²ç«å¢™é…ç½®ï¼ˆç²¾å‡†å¼€æ”¾ç«¯å£ï¼‰ ======================
echo "[2/10] æ­£åœ¨é…ç½®é˜²ç«å¢™..."
sudo ufw --force reset 2>/dev/null || true
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 3306/tcp comment 'MySQL'
sudo ufw allow 3724/tcp comment 'AuthServer'
sudo ufw allow 8085/tcp comment 'WorldServer'
sudo ufw --force enable
echo "é˜²ç«å¢™çŠ¶æ€:"
sudo ufw status numbered

# ====================== ä¿®å¤MySQLè¿œç¨‹è®¿é—® ======================
echo "[3/10] ä¿®å¤MySQLé…ç½®..."
sudo sed -i 's/^bind-address.*/bind-address = 0.0.0.0/' /etc/mysql/mysql.conf.d/mysqld.cnf
sudo systemctl restart mysql

# ====================== æºç ç¼–è¯‘ä¸å®‰è£… ======================
echo "[4/10] æ­£åœ¨éƒ¨ç½²æ ¸å¿ƒæœåŠ¡..."
mkdir -p "$WORK_DIR/ai_wow" && cd "$WORK_DIR/ai_wow" || exit 1

# æ ¸å¿ƒä¿®æ­£2ï¼šä½¿ç”¨æ­£ç¡®ä»“åº“åœ°å€ï¼ˆå®˜æ–¹å…¼å®¹åˆ†æ”¯ï¼‰
git clone https://github.com/liyunfan1223/azerothcore-wotlk.git --branch=Playerbot

# æ·»åŠ AIæ¨¡å—ï¼ˆä¿®æ­£ä»“åº“åœ°å€ï¼‰
cd azerothcore-wotlk/modules || exit 1
git clone https://github.com/liyunfan1223/mod-playerbots.git --branch=master

# ç¼–è¯‘å®‰è£…ï¼ˆæ ¸å¿ƒä¿®æ­£3ï¼šæ·»åŠ -DPLAYERBOTS=ONï¼‰
cd "$WORK_DIR/ai_wow/azerothcore-wotlk" || exit 1
mkdir build && cd build || exit 1
cmake ../ \
  -DCMAKE_INSTALL_PREFIX="$WORK_DIR/ai_server/" \
  -DCMAKE_C_COMPILER=/usr/bin/clang \
  -DCMAKE_CXX_COMPILER=/usr/bin/clang++ \
  -DWITH_WARNINGS=1 \
  -DTOOLS_BUILD=all \
  -DSCRIPTS=static \
  -DMODULES=static \
  -DPLAYERBOTS=ON  # å…³é”®ï¼å¯ç”¨Playerbotsæ¨¡å—

echo "[5/10] æ­£åœ¨ç¼–è¯‘æºç ï¼ˆæ™ºèƒ½çº¿ç¨‹æ•°ï¼‰..."
make -j$(( $(nproc) > 4 ? 4 : $(nproc) ))  # å®‰å…¨çº¿ç¨‹æ•°
make install

# ====================== å®¢æˆ·ç«¯æ•°æ®éƒ¨ç½² ======================
echo "[6/10] æ­£åœ¨ä¸‹è½½å®˜æ–¹éªŒè¯åœ°å›¾æ•°æ®..."
mkdir -p "$WORK_DIR/ai_server/data"
# æ ¸å¿ƒä¿®æ­£4ï¼šä½¿ç”¨å®˜æ–¹é¢„æå–åœ°å›¾åŒ…ï¼ˆå«MMapsï¼‰
wget -O "$WORK_DIR/ai_server/data/Data.zip" \
  https://github.com/wowgaming/client-data/releases/download/v19/Data.zip

unzip -o "$WORK_DIR/ai_server/data/Data.zip" -d "$WORK_DIR/ai_server/data/"
rm "$WORK_DIR/ai_server/data/Data.zip"
# ä¿®å¤æƒé™ï¼ˆé¿å…å¯åŠ¨å¤±è´¥ï¼‰
chown -R $USER:$USER "$WORK_DIR/ai_server/data"

# ====================== é…ç½®æ–‡ä»¶ä¿®æ­£ ======================
echo "[7/10] æ­£åœ¨é…ç½®æœåŠ¡..."
cd "$WORK_DIR/ai_server/etc" || exit 1

# ç”Ÿæˆé…ç½®æ–‡ä»¶
cp authserver.conf.dist authserver.conf
cp worldserver.conf.dist worldserver.conf
mkdir -p modules
cp modules/playerbots.conf.dist modules/playerbots.conf

# æ ¸å¿ƒä¿®æ­£5ï¼šç²¾å‡†ä¿®æ”¹è·¯å¾„ï¼ˆé¿å…åŒæ–œæ é”™è¯¯ï¼‰
sed -i "s|DataDir = \".*\"|DataDir = \"$WORK_DIR/ai_server/data\"|" worldserver.conf
sed -i "s|LogsDir = \".*\"|LogsDir = \"$WORK_DIR/ai_server/logs\"|" worldserver.conf

# ä¿®æ­£Playerbotsé…ç½®ï¼ˆå…³é”®ï¼ï¼‰
sed -i 's/AiPlayerbot.RandomBotAutologin = 1/AiPlayerbot.RandomBotAutologin = 0/' modules/playerbots.conf

# ====================== æ•°æ®åº“åˆå§‹åŒ– ======================
echo "[8/10] æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“..."
sudo mysql <<EOF
-- æ ¸å¿ƒä¿®æ­£6ï¼šæœ€å°æƒé™åŸåˆ™ï¼ˆé*.*ï¼‰
DROP USER IF EXISTS 'acore'@'%';
CREATE USER 'acore'@'%' IDENTIFIED BY 'acore';

CREATE DATABASE IF NOT EXISTS \`acore_world\` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
CREATE DATABASE IF NOT EXISTS \`acore_characters\` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
CREATE DATABASE IF NOT EXISTS \`acore_auth\` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

GRANT ALL PRIVILEGES ON \`acore_world\`.* TO 'acore'@'%';
GRANT ALL PRIVILEGES ON \`acore_characters\`.* TO 'acore'@'%';
GRANT ALL PRIVILEGES ON \`acore_auth\`.* TO 'acore'@'%';
FLUSH PRIVILEGES;
EOF

# æ ¸å¿ƒä¿®æ­£7ï¼šå¼ºåˆ¶å¯¼å…¥PlayerbotsåŸºç¡€è¡¨ï¼ˆè§£å†³å†å²æŠ¥é”™ï¼‰
echo "[8.5/10] åˆå§‹åŒ–Playerbotsæ•°æ®åº“è¡¨..."
cd "$WORK_DIR/ai_wow/azerothcore-wotlk/modules/mod-playerbots/data/sql/characters/base" || exit 1
for sql in *.sql; do
  echo ">>> å¯¼å…¥: $sql"
  mysql -uacore -pacore acore_characters < "$sql"
done
echo "âœ… PlayerbotsåŸºç¡€è¡¨åˆ›å»ºå®Œæˆ"

# ====================== æœåŠ¡å¯åŠ¨ä¸éªŒè¯ ======================
echo "[9/10] é‡å¯æ•°æ®åº“æœåŠ¡..."
sudo systemctl restart mysql

echo "[10/10] å¯åŠ¨æ¸¸æˆæœåŠ¡..."
cd "$WORK_DIR/ai_server/bin" || exit 1

# ä½¿ç”¨screenå®ˆæŠ¤è¿›ç¨‹
screen -dmS authserver ./authserver
screen -dmS worldserver ./worldserver

# ====================== æœ€ç»ˆéªŒè¯ ======================
echo "========================="
echo "ğŸš€ å®‰è£…å®Œæˆï¼éªŒè¯çŠ¶æ€:"
echo "   - é˜²ç«å¢™: $(sudo ufw status | grep -c '3724.*ALLOW')"
echo "   - åœ°å›¾æ–‡ä»¶: $(ls $WORK_DIR/ai_server/data/maps/0004231.map 2>/dev/null | wc -l)"
echo "   - Playerbotsè¡¨: $(mysql -uacore -pacore acore_characters -e 'SHOW TABLES LIKE "playerbots%";' 2>/dev/null | grep -c playerbots)"
echo "   - æœåŠ¡çŠ¶æ€:"
screen -ls | grep -E 'authserver|worldserver'

echo ""
echo "ğŸ” è¯Šæ–­å‘½ä»¤:"
echo "   æŸ¥çœ‹è®¤è¯æ—¥å¿—: screen -r authserver"
echo "   æŸ¥çœ‹ä¸–ç•Œæ—¥å¿—: screen -r worldserver (æŒ‰Ctrl+A, Dé€€å‡º)"
echo "   éªŒè¯åœ°å›¾: ls $WORK_DIR/ai_server/data/maps/*.map | head -3"
echo ""
echo "ğŸ® åˆ›å»ºç®¡ç†å‘˜è´¦å· (åœ¨worldserveræ§åˆ¶å°æ‰§è¡Œ):"
echo "   account create admin admin admin
echo "   account set gmlevel admin 3 -1"
echo "========================="
